\hypertarget{context_8h}{}\section{mos/context.h File Reference}
\label{context_8h}\index{mos/context.\+h@{mos/context.\+h}}


Shared Contexts.  


{\ttfamily \#include $<$mos/kernel.\+h$>$}\newline
{\ttfamily \#include $<$mos/queue.\+h$>$}\newline
{\ttfamily \#include $<$mos/trace.\+h$>$}\newline
Include dependency graph for context.\+h\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=337pt]{context_8h__incl}
\end{center}
\end{figure}
\subsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structMosContextMessage}{Mos\+Context\+Message}
\item 
struct \hyperlink{structMosClient}{Mos\+Client}
\item 
struct \hyperlink{structMosContext}{Mos\+Context}
\item 
struct \hyperlink{structMosContextTimer}{Mos\+Context\+Timer}
\end{DoxyCompactItemize}
\subsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{context_8h_a0f5a5853b5404b549587f080762d82c0}\label{context_8h_a0f5a5853b5404b549587f080762d82c0}} 
typedef u32 {\bfseries Mos\+Context\+Message\+ID}
\item 
\mbox{\Hypertarget{context_8h_a762ad564702708ead70e0b7edf9dc8f3}\label{context_8h_a762ad564702708ead70e0b7edf9dc8f3}} 
typedef bool() {\bfseries Mos\+Client\+Handler}(\hyperlink{structMosContextMessage}{Mos\+Context\+Message} $\ast$)
\item 
\mbox{\Hypertarget{context_8h_abcf071288b0b41b19de23f4ad9be9278}\label{context_8h_abcf071288b0b41b19de23f4ad9be9278}} 
typedef struct \hyperlink{structMosClient}{Mos\+Client} {\bfseries Mos\+Client}
\end{DoxyCompactItemize}
\subsection*{Enumerations}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{context_8h_a41e6609804d83834dc1a19f92e828492}\label{context_8h_a41e6609804d83834dc1a19f92e828492}} 
enum {\bfseries Mos\+Context\+Message\+ID} \{ \newline
{\bfseries Mos\+Context\+Message\+I\+D\+\_\+\+Start\+Client} = 0x\+F\+F\+F\+F\+F\+F\+FC, 
{\bfseries Mos\+Context\+Message\+I\+D\+\_\+\+Stop\+Client} = 0x\+F\+F\+F\+F\+F\+F\+FD, 
{\bfseries Mos\+Context\+Message\+I\+D\+\_\+\+Resume\+Client} = 0x\+F\+F\+F\+F\+F\+F\+FE, 
{\bfseries Mos\+Context\+Message\+I\+D\+\_\+\+Stop\+Context} = 0x\+F\+F\+F\+F\+F\+F\+FF, 
\newline
{\bfseries Mos\+Context\+Message\+I\+D\+\_\+\+First\+User\+Message} = 0x00000000
 \}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\Hypertarget{context_8h_a96873fd8971410364f0f49b20245efc2}\label{context_8h_a96873fd8971410364f0f49b20245efc2}} 
M\+O\+S\+\_\+\+C\+L\+I\+E\+N\+T\+\_\+\+U\+N\+S\+A\+FE void {\bfseries Mos\+Init\+Context} (\hyperlink{structMosContext}{Mos\+Context} $\ast$context, Mos\+Thread\+Priority prio, u8 $\ast$stack\+\_\+bottom, u32 stack\+\_\+size, \hyperlink{structMosContextMessage}{Mos\+Context\+Message} $\ast$msg\+\_\+queue\+\_\+buf, u32 msg\+\_\+queue\+\_\+depth)
\item 
\mbox{\Hypertarget{context_8h_ac6240b974e98bbdd2b3d56b0e5625442}\label{context_8h_ac6240b974e98bbdd2b3d56b0e5625442}} 
M\+O\+S\+\_\+\+C\+L\+I\+E\+N\+T\+\_\+\+U\+N\+S\+A\+FE void {\bfseries Mos\+Start\+Context} (\hyperlink{structMosContext}{Mos\+Context} $\ast$context)
\item 
\mbox{\Hypertarget{context_8h_ac11f2b251810f7991bf5b2b92ec4a57f}\label{context_8h_ac11f2b251810f7991bf5b2b92ec4a57f}} 
M\+O\+S\+\_\+\+C\+L\+I\+E\+N\+T\+\_\+\+U\+N\+S\+A\+FE void {\bfseries Mos\+Stop\+Context} (\hyperlink{structMosContext}{Mos\+Context} $\ast$context)
\item 
\mbox{\Hypertarget{context_8h_aa46e2b7a2cbb13db129414450ba70b00}\label{context_8h_aa46e2b7a2cbb13db129414450ba70b00}} 
M\+O\+S\+\_\+\+C\+L\+I\+E\+N\+T\+\_\+\+U\+N\+S\+A\+FE void {\bfseries Mos\+Wait\+For\+Context\+Stop} (\hyperlink{structMosContext}{Mos\+Context} $\ast$context)
\item 
\mbox{\Hypertarget{context_8h_af3e9ac5ba76d2926ed6216e1389bb2b6}\label{context_8h_af3e9ac5ba76d2926ed6216e1389bb2b6}} 
M\+O\+S\+\_\+\+C\+L\+I\+E\+N\+T\+\_\+\+U\+N\+S\+A\+FE void {\bfseries Mos\+Start\+Client} (\hyperlink{structMosContext}{Mos\+Context} $\ast$context, \hyperlink{structMosClient}{Mos\+Client} $\ast$client, Mos\+Client\+Handler $\ast$handler, void $\ast$priv\+\_\+data)
\item 
\mbox{\Hypertarget{context_8h_a86b994bbd386c225198fb7a28640f56e}\label{context_8h_a86b994bbd386c225198fb7a28640f56e}} 
M\+O\+S\+\_\+\+C\+L\+I\+E\+N\+T\+\_\+\+U\+N\+S\+A\+FE void {\bfseries Mos\+Stop\+Client} (\hyperlink{structMosContext}{Mos\+Context} $\ast$context, \hyperlink{structMosClient}{Mos\+Client} $\ast$client)
\item 
\mbox{\Hypertarget{context_8h_a6bd8d3e555c9f18cca96dda0419b3f46}\label{context_8h_a6bd8d3e555c9f18cca96dda0419b3f46}} 
M\+O\+S\+\_\+\+I\+S\+R\+\_\+\+S\+A\+FE M\+O\+S\+\_\+\+I\+N\+L\+I\+NE void {\bfseries Mos\+Set\+Context\+Message} (\hyperlink{structMosContextMessage}{Mos\+Context\+Message} $\ast$msg, \hyperlink{structMosClient}{Mos\+Client} $\ast$client, Mos\+Context\+Message\+ID id)
\item 
\mbox{\Hypertarget{context_8h_a6e60f6d8855e6ec1a543bc85f408afa3}\label{context_8h_a6e60f6d8855e6ec1a543bc85f408afa3}} 
M\+O\+S\+\_\+\+I\+S\+R\+\_\+\+S\+A\+FE M\+O\+S\+\_\+\+I\+N\+L\+I\+NE void {\bfseries Mos\+Set\+Context\+Broadcast\+Message} (\hyperlink{structMosContextMessage}{Mos\+Context\+Message} $\ast$msg, Mos\+Context\+Message\+ID id)
\item 
\mbox{\Hypertarget{context_8h_aeadf0881d123527759698865866a2b69}\label{context_8h_aeadf0881d123527759698865866a2b69}} 
M\+O\+S\+\_\+\+I\+S\+R\+\_\+\+S\+A\+FE M\+O\+S\+\_\+\+I\+N\+L\+I\+NE void {\bfseries Mos\+Set\+Context\+Message\+Data} (\hyperlink{structMosContextMessage}{Mos\+Context\+Message} $\ast$msg, void $\ast$data)
\item 
\mbox{\Hypertarget{context_8h_a8d50a51799615d42668d58ee132c91ff}\label{context_8h_a8d50a51799615d42668d58ee132c91ff}} 
M\+O\+S\+\_\+\+I\+S\+R\+\_\+\+S\+A\+FE M\+O\+S\+\_\+\+I\+N\+L\+I\+NE bool {\bfseries Mos\+Try\+Send\+Message\+To\+Context} (\hyperlink{structMosContext}{Mos\+Context} $\ast$context, \hyperlink{structMosContextMessage}{Mos\+Context\+Message} $\ast$msg)
\item 
\mbox{\Hypertarget{context_8h_abb8bbb14dfac4db77c431c91f8b6a4d2}\label{context_8h_abb8bbb14dfac4db77c431c91f8b6a4d2}} 
M\+O\+S\+\_\+\+I\+N\+L\+I\+NE void {\bfseries Mos\+Send\+Message\+To\+Context} (\hyperlink{structMosContext}{Mos\+Context} $\ast$context, \hyperlink{structMosContextMessage}{Mos\+Context\+Message} $\ast$msg)
\item 
\mbox{\Hypertarget{context_8h_a1a25826ddaac2d265bd7c8ed47e13981}\label{context_8h_a1a25826ddaac2d265bd7c8ed47e13981}} 
void {\bfseries Mos\+Init\+Context\+Timer} (\hyperlink{structMosContextTimer}{Mos\+Context\+Timer} $\ast$tmr, \hyperlink{structMosContext}{Mos\+Context} $\ast$context)
\item 
\mbox{\Hypertarget{context_8h_a5431ec458899ef7c0a89fa6f6561f74f}\label{context_8h_a5431ec458899ef7c0a89fa6f6561f74f}} 
M\+O\+S\+\_\+\+I\+N\+L\+I\+NE void {\bfseries Mos\+Set\+Context\+Timer} (\hyperlink{structMosContextTimer}{Mos\+Context\+Timer} $\ast$tmr, u32 ticks, \hyperlink{structMosContextMessage}{Mos\+Context\+Message} $\ast$msg)
\item 
\mbox{\Hypertarget{context_8h_a8ae38a2929592a2651c63988c54c86b7}\label{context_8h_a8ae38a2929592a2651c63988c54c86b7}} 
M\+O\+S\+\_\+\+I\+N\+L\+I\+NE void {\bfseries Mos\+Cancel\+Context\+Timer} (\hyperlink{structMosContextTimer}{Mos\+Context\+Timer} $\ast$tmr)
\item 
\mbox{\Hypertarget{context_8h_a65d86ac9d993f0adb3c8a93d00dc2228}\label{context_8h_a65d86ac9d993f0adb3c8a93d00dc2228}} 
M\+O\+S\+\_\+\+I\+N\+L\+I\+NE void {\bfseries Mos\+Reset\+Context\+Timer} (\hyperlink{structMosContextTimer}{Mos\+Context\+Timer} $\ast$tmr)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Shared Contexts. 

Shared contexts allow multiple client modules to share the same resources, including a single run thread, thread stack and message queue. In addition, shared contexts can reduce or eliminate mutex contention since clients in the same shared context are guaranteed to not preempt each other. In general, shared contexts should be implemented at lower thread priorities than most other functionality. Think of contexts as a form of cooperative multitasking where memory savings are a lot more important than deadlines.

Contexts use a shared message queue for inter-\/client communication. The maximum latency depends on the maximum processing time for all messages in the context. Context clients should be implemented as state machines that multiplex received messages. Contexts can send and receive messages to or from I\+S\+Rs or other threads on the system. Clients should not block or wait very long otherwise they might starve other clients sharing the same context. The Mos\+Try\+Send\+Message\+To\+Context() call should be used when a client sends a message to another client in the same context.

If a client handler has not completed and desires a callback, it should return false. Note that the callback is implemented as a resume message on the same message queue. The resume message will be added to the end of the queue allowing the opportunity for other messages to drain first.

Client handlers state machines should tolerate receiving messages after being {\itshape individually} stopped. This includes, but is not limited to broadcast stop messages, resume messages or potentially even user messages (depending on the system design and how the context is used).

The overall context will only shutdown upon receipt of a {\itshape broadcast} Stop\+Context message and any messages that are queued beyond a {\itshape broadcast} Stop\+Contextmessage will be ignored. Any clients requesting resume after receiving a broadcast Stop\+Context stop message will also be ignored. All clients will receive a Stop\+Client message upon receipt of a {\itshape broadcast} Stop\+Context message (even if already stopped). 